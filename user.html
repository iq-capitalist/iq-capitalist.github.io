<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–æ–∫ | IQ Capitalist</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/user.css">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞–ø–∏—Ç–∞–ª–∞" */
        .sources-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .source-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .source-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .source-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .source-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .source-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }

        .player-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--card-header-color);
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <header id="header"></header>

    <main>
        <div class="container">
            <h1 id="playerNameTitle" class="page-title">–ò–≥—Ä–æ–∫</h1>
            
            <div id="loadingIndicator" class="loading-indicator">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞.</p>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>

            <div id="playerNotFound" class="not-found-message" style="display: none;">
                <p>–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>
                <button class="btn btn-primary mt-3" onclick="window.location.href='players.html'">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∏–≥—Ä–æ–∫–æ–≤
                </button>
            </div>
            
            <div id="playerProfile" style="display: none;">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
                <div class="player-card">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon">üë§</div>
                            <div class="stat-value" id="playerLevel">–£—Ä–æ–≤–µ–Ω—å</div>
                            <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-value" id="playerCapital">0</div>
                            <div class="stat-label">–ö–∞–ø–∏—Ç–∞–ª</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üíµ</div>
                            <div class="stat-value" id="playerWallet">0</div>
                            <div class="stat-label">–ö–æ—à–µ–ª—ë–∫</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">‚ùì</div>
                            <div class="stat-value" id="playerQuestions">0</div>
                            <div class="stat-label">–û—Ç–≤–µ—Ç—ã</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üöÄ</div>
                            <div class="stat-value" id="playerBoosters">0</div>
                            <div class="stat-label">–ë—É—Å—Ç–µ—Ä—ã</div>
                        </div>
                    </div>
                </div>
                
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∫–∞–ø–∏—Ç–∞–ª–∞ -->
                <div class="player-card" id="capitalSources">
                    <h3>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞–ø–∏—Ç–∞–ª–∞</h3>
                    <div class="sources-grid">
                        <div class="source-item">
                            <div class="source-icon">üë•</div>
                            <div class="source-value" id="referralReward">0</div>
                            <div class="source-label">IQC –∑–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ <span id="referredCount">0</span> –∏–≥—Ä–æ–∫–æ–≤</div>
                        </div>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º -->
                <div class="chart-section">
                    <h3>–û—Ç–≤–µ—Ç—ã –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º</h3>
                    <div class="chart-container">
                        <canvas id="answersProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫ –æ—á–∫–æ–≤ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º -->
                <div class="chart-section">
                    <h3>–û—á–∫–∏ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º</h3>
                    <div class="chart-container">
                        <canvas id="pointsProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–∑–æ–≤ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º -->
                <div class="chart-section">
                    <h3>–ü—Ä–∏–∑—ã –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º</h3>
                    <div class="chart-container">
                        <canvas id="prizesProgressChart"></canvas>
                    </div>
                </div>
                
                <!-- –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="chart-section">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤</h3>
                    <div class="chart-container">
                        <canvas id="answersStatsChart"></canvas>
                    </div>
                </div>
                
                <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤ -->
                <div class="history-section">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è —Ç—É—Ä–Ω–∏—Ä–æ–≤</h3>
                    <div class="table-responsive">
                        <table class="tournament-history-table">
                            <thead>
                                <tr>
                                    <th>–¢—É—Ä–Ω–∏—Ä</th>
                                    <th>–£—Ä–æ–≤–µ–Ω—å</th>
                                    <th>–û—Ç–≤–µ—Ç—ã</th>
                                    <th>–û—á–∫–∏</th>
                                    <th>–ü—Ä–∏–∑</th>
                                </tr>
                            </thead>
                            <tbody id="tournamentHistoryTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ –æ —Ç—É—Ä–Ω–∏—Ä–∞—Ö –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer"></footer>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script src="js/main.js"></script>
    <script src="js/user.js"></script>
    
    <!-- –î–æ–±–∞–≤–ª—è–µ–º JS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ -->
    <script>
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         * @param {string} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        async function loadReferralData(userId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥–∞—Ö
                const response = await fetch(`data/referral_rewards.json`);
                const referralData = await response.json();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (referralData && referralData.rewards) {
                    const userRewards = referralData.rewards.filter(reward => 
                        reward.referrer_id == userId
                    );
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (playerData) {
                        playerData.referral_rewards = userRewards;
                    }
                }
                
                return true;
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                // –≠—Ç–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞, –ø–æ—ç—Ç–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                return true;
            }
        }

        /**
         * –†–∞—Å—á–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
         */
        function displayReferralData() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!playerData || !playerData.referral_rewards) {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫
                const capitalSourcesBlock = document.getElementById('capitalSources');
                if (capitalSourcesBlock) {
                    capitalSourcesBlock.style.display = 'none';
                }
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞–≥—Ä–∞–¥–∞—Ö –ø–æ 20 –º–æ–Ω–µ—Ç
            let totalReward20 = 0;
            let totalReferrals = 0;

            playerData.referral_rewards.forEach(reward => {
                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–≥—Ä–∞–¥ –ø–æ 20 –º–æ–Ω–µ—Ç –ø–æ —Ñ–æ—Ä–º—É–ª–µ –∏–∑ SQL
                // (reward_amount - 10 * rewards_given) / 10
                const rewards20 = Math.max(0, Math.floor((reward.reward_amount - 10 * reward.rewards_given) / 10));
                
                if (rewards20 > 0) {
                    totalReward20 += rewards20 * 20; // –∫–∞–∂–¥–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –ø–æ 20 –º–æ–Ω–µ—Ç
                    totalReferrals += 1; // +1 –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–π –∏–≥—Ä–æ–∫
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const referralRewardElement = document.getElementById('referralReward');
            const referredCountElement = document.getElementById('referredCount');

            if (referralRewardElement) {
                referralRewardElement.textContent = formatNumber(totalReward20);
            }

            if (referredCountElement) {
                referredCountElement.textContent = totalReferrals;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
            const capitalSourcesBlock = document.getElementById('capitalSources');
            if (capitalSourcesBlock) {
                capitalSourcesBlock.style.display = totalReward20 > 0 ? 'block' : 'none';
            }
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é displayPlayerProfile
        const originalDisplayPlayerProfile = displayPlayerProfile;
        
        displayPlayerProfile = function() {
            // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            originalDisplayPlayerProfile();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            displayReferralData();
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        const originalDOMContentLoaded = document.onreadystatechange;
        
        // –ü–∞—Ç—á–∏–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–ª—è—è –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–ª—É—á–∞–µ–º ID –∏–≥—Ä–æ–∫–∞ –∏–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');
            
            if (!userId) {
                showPlayerNotFound();
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
            loadPlayerData(userId)
                .then(data => {
                    if (!data) {
                        showPlayerNotFound();
                        return;
                    }
                    
                    playerData = data;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    return loadReferralData(userId);
                })
                .then(referralDataLoaded => {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç—É—Ä–Ω–∏—Ä–∞—Ö
                    return loadTournamentsIndex();
                })
                .then(tournamentsIndex => {
                    if (!tournamentsIndex) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–¥–µ–∫—Å —Ç—É—Ä–Ω–∏—Ä–æ–≤, –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                        displayPlayerProfile();
                        return;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å —Ç—É—Ä–Ω–∏—Ä–æ–≤
                    tournamentsData = tournamentsIndex.tournaments;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏–≥—Ä–æ–∫–∞
                    return loadPlayerTournamentHistory();
                })
                .then(() => {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    displayPlayerProfile();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    showError();
                });
        });
    </script>
</body>
</html>
